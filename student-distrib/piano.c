#include "piano.h"
#include "pit.h"

#define IRQ_LINE_KEYBOARD 0x01
#define KEYBOARD_PORT_ADDR 0x60

// create the keyboard map
int piano_key_map[128] = {
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  
      0,   0, 277, 311,   0, 370, 415, 466,   0,   554,   622,   0,   0,   0,
      0, 261, 294, 330, 350, 392, 440, 494, 523,   587,   660,   698,   740,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0
};

float cur_octave = 1.0;
int cur_octave_count = 4;
extern volatile int piano;

/* 
 * piano_handler_init
 *   DESCRIPTION: Handles the keyboard initialization
 *   INPUTS: none
 *   OUTPUTS: none
 *   RETURN VALUE: none
 *   SIDE EFFECTS: clobbers ports for device
 */
void piano_handler_init() {
    printf("reached piano init %d\n", piano);
    // enable interrupts
    enable_irq(IRQ_LINE_KEYBOARD);
    // clear the screen
    // clear();
    return; 
}

/* 
 * piano_handler
 *   DESCRIPTION: interrupt handler for keyboard
 *   INPUTS: none
 *   OUTPUTS: none
 *   RETURN VALUE: none
 *   SIDE EFFECTS: clobbers ports for device
 */
void piano_handler(int scan_code) {
    //printf("reached piano handler %d\n", piano);
    // printf("test");

    if(scan_code == 157) {//j opcode
        piano = 0;
        send_eoi(IRQ_LINE_KEYBOARD);
        return; 
    }

    static char piano_art[] = {0x20, 0x20, 0x5F, 0x20, 0x5F, 0x5F, 0x20, 0x28, 0x5F, 0x29, 0x20, 0x5F, 0x5F, 0x20, 0x5F, 0x20, 0x5F, 0x20, 0x5F, 0x5F, 0x20, 0x20, 0x20, 0x5F, 0x5F, 0x5F, 0x0A, 0x20, 0x7C, 0x20, 0x27, 0x5F, 0x20, 0x5C, 0x7C, 0x20, 0x7C, 0x2F, 0x20, 0x5F, 0x60, 0x20, 0x7C, 0x20, 0x27, 0x5F, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x5F, 0x20, 0x5C, 0x0A, 0x20, 0x7C, 0x20, 0x7C, 0x5F, 0x29, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x28, 0x5F, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x28, 0x5F, 0x29, 0x20, 0x5C, 0x0A, 0x20, 0x7C, 0x20, 0x2E, 0x5F, 0x5F, 0x2F, 0x7C, 0x5F, 0x7C, 0x5C, 0x5F, 0x5F, 0x2C, 0x5F, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x5C, 0x5F, 0x5F, 0x5F, 0x2F, 0x0A, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x20, 0x20, 0x0A, 0x0A, 0x20, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x0A, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x20, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x7C, 0x5F, 0x7C, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x0A, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x7C, 0x0A};

    // printf("%d", sizeof(piano_art));
    clear();
    set_screen(0, 0);
    puts_keyboard(piano_art);
    printf_keyboard("\n\n OCTAVE : %d           Press ctrl to EXIT", cur_octave_count);

    
    // 0x4d is the upper bound for preventing the key up scancode
    if(scan_code > 0x4d) {
        // send eoi if scancode out of bounds
        send_eoi(IRQ_LINE_KEYBOARD);
        return;
    }

    if(scan_code == 77 && cur_octave_count < 7){
        cur_octave *= 2;
        cur_octave_count++;
    }

    if(scan_code == 75 && cur_octave_count > 1){
        cur_octave /= 2;
        cur_octave_count--;
    }

    // printf("%d ", scan_code);
    if(piano_key_map[scan_code] > 0)
        note((int)(piano_key_map[scan_code] * cur_octave), 1);

    // write character to the screen
    // printf("%d", piano_key_map[scan_code]);

    // printf("\n\n OCTAVE : %d", cur_octave_count);
    
    // send eoi once done
    send_eoi(IRQ_LINE_KEYBOARD);

    return;
}
